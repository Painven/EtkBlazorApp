@page "/price-list/products-price-history/{TemplateGuid}"
@using EtkBlazorApp.BL.Managers
@attribute [Authorize(Roles = "Manager, Administrator")]



@if (historyData is null)
{
    <h1>Загрузка данных</h1>
    <LoadingSpinner />
}
else if (historyData.Data.Count == 0)
{
    <h2>Нет данных по изменению цен</h2>
}
else
{
    <div class="mx-auto d-block image-select-container m-1 p-1">
        <img src="@priceListData.Image" class="rounded image" style="width: 100%; height: 100%;" />
    </div>
    <h3>История изменения цена на товары в прайс-листе @priceListData.Title</h3>
    <div class="table-responsive">
        <table class="table table-bordered product-price-update-history-table">
            <thead>
                <tr>
                    <th rowspan="2">Товар</th>
                    <th colspan="2">Актуальная</th>
                    <th colspan="2">Прежняя</th>
                    <th colspan="2" rowspan="2">Изменение</th>
                </tr>
                <tr>
                    <th>Дата</th>
                    <th>Цена</th>
                    <th>Дата</th>
                    <th>Цена</th>
                </tr>
            </thead>
            @foreach (var item in historyData.Data)
            {
                <tr>
                    <td>@item.ProductName</td>
                    <td>@item.DateTime.ToShortDateString()</td>
                    <td>@item.Price.ToString("C0")</td>
                    <td>@item.PreviousItem.DateTime.ToShortDateString()</td>
                    <td>@item.PreviousItem.Price.ToString("C0")</td>
                    <td>@item.ChangePercent.ToString("P2")</td>
                    <td>@item.ChangeInCurrency.ToString("C0")</td>
                </tr>
            }
        </table>
    </div>
}

<style>
    .product-price-update-history-table th {
        text-align: center;
        vertical-align: middle;
    }
</style>

@code {
    [Parameter] public string TemplateGuid { get; set; }
    [Inject] public PriceListPriceHistoryManager HistoryManager { get; set; }
    [Inject] public IPriceListTemplateStorage PriceListRepository { get; set; }
    [Inject] public IMapper Mapper { get; set; }

    PriceListProductPriceChangeHistory historyData;
    PriceListTemplateItemViewModel priceListData;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            historyData = await HistoryManager.GetProductsPriceChangeHistoryForPriceList(TemplateGuid);

            priceListData = Mapper.Map<PriceListTemplateItemViewModel>(await PriceListRepository.GetPriceListTemplateById(TemplateGuid));

            StateHasChanged();
        }
    }
}
