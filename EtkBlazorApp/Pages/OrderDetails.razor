@page "/order/{id:int}"
@inject IOrderStorage database
@inject IJSRuntime js
@inject NavigationManager navigationManager
@attribute [Authorize(Roles = "Administrator, Manager")]

@if (order == null)
{
    <LoadingSpinner />
}
else
{
    <h1>Детали заказа <button class="btn btn-sm btn-secondary" @onclick="GoToPrintPage"><span class="oi oi-print"></span></button></h1>
    

    <div class="container-fluid" style="padding-bottom: 30px;">

        <h3>Основные данные</h3>
        <div class="row order-details-row">
            <div class="col-md-2">
                <p>Номер заказа</p>
                <input type="text" readonly value="@order.OrderId" class="form-control" />
            </div>
            <div class="col-md-2">
                <p>Дата заказа</p>
                <input type="text" readonly value="@order.DateTime.ToString("g")" class="form-control" />
            </div>
            <div class="col-md-8">
                <p>Заказчик</p>
                <input type="text" readonly value="@(HttpUtility.HtmlDecode(order.Customer))" class="form-control" />
            </div>
        </div>
        <div class="row order-details-row">
            <div class="col-md-2">
                <p>Город</p>
                <input type="text" readonly value="@order.City" class="form-control" />
            </div>
            <div class="col-md-2">
                <p>Телефон заказчика</p>
                <input type="text" readonly value="@order.CustomerPhoneNumber" class="form-control" />
            </div>
            <div class="col-md-2">
                <p>Email заказчика</p>
                <input type="text" readonly value="@order.CustomerEmail" class="form-control" />
            </div>
            <div class="col-md-6">
                <p>Вид оплаты</p>
                <input type="text" readonly value="@order.PaymentMethod" class="form-control" />
            </div>
        </div>

        <h3>Доставка</h3>
        <div class="row order-details-row">
            <div class="col-md-6">
                <p>Адрес доставки@*<button class="btn btn-sm" @onclick="YandexMapSearch"><span class="oi oi-map-marker"></span></button>*@</p>
                <input type="text" readonly value="@order.ShippingAddress" class="form-control" />          
            </div>
            <div class="col-md-6">
                <p>Метод доставки</p>
                <input type="text" readonly value="@(HttpUtility.HtmlDecode(order.ShippingMethod))" class="form-control" />
            </div>
        </div>

        <hr style="margin: 20px auto;" />

        <div class="row">
            <div class="col-md-2" style="padding-bottom:40px;@(hasLinkedOrders ? "" : "display: none;")">
                <h3>Другие заказы этого клиента</h3>
                <select multiple class="form-control" style="height: 100%; overflow-y: hidden;">
                    @foreach (var linkedOrder in linkedOrders)
                    {
                        <option value="@linkedOrder.order_id" @ondblclick="(e => OnLinkedOrderMouseDoubleClick(linkedOrder))">
                            @($"{linkedOrder.order_id} от {linkedOrder.date_added.ToShortDateString()}")
                        </option>
                    }
                </select>
            </div>
            <div class="@(hasLinkedOrders ? "col-md-10" : "col-md-12")">
                <div class="table-responsive">
                    <table class="table">
                        <thead class="thead-etk">
                            <tr>
                                <th>Производитель</th>
                                <th>Наименование</th>
                                <th>Модель</th>
                                <th>Артикул</th>
                                <th>Цена, за ед.<br /><small>(на момент заказа)</small></th>
                                <th>Количество</th>
                                <th>Сумма</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var detail in order.OrderDetails)
                            {
                                <tr>
                                    <td>@detail.Manufacturer</td>
                                    <td>
                                        <a href="https://etk-komplekt.ru/index.php?route=product/product&product_id=@detail.ProductId"
                                           target="_blank">
                                            @(HttpUtility.HtmlDecode(detail.ProductName))
                                        </a>
                                    </td>
                                    <td>@(HttpUtility.HtmlDecode(detail.Model))</td>
                                    <td>@detail.Sku</td>
                                    <td>@detail.Price.ToString("C0")</td>
                                    <td>@detail.Quantity</td>
                                    <td>@detail.Sum.ToString("C0")</td>
                                </tr>
                            }
                            <tr>
                                <td colspan="5"></td>
                                <td style="color: red; font-weight: bold;">@order.ProductsTotalQuantity</td>
                                <td style="color: red; font-weight: bold;">@order.ProductsTotalCost.ToString("C0")</td>
                            </tr>
                            <tr>
                                <td colspan="5"></td>
                                <td style="color: red; font-weight: bold;">Доставка</td>
                                <td style="color: red; font-weight: bold;">@order.ShipmentCost.ToString("C0")</td>
                            </tr>
                            <tr style="border-top: 2px solid #33121933">
                                <td colspan="5"></td>
                                <td style="color: red; font-weight: bold;">ИТОГО</td>
                                <td style="color: red; font-weight: bold;">@order.TotalPrice.ToString("C0")</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <p>Комментарий к заказу</p>
                        <textarea readonly value="@order.Comment" class="form-control" style="height: auto; width: 100%; margin: auto 20px;" />
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {

    [Parameter]
    public int Id { get; set; }

    OrderViewModel order = null;

    List<OrderEntity> linkedOrders = null;
    bool hasLinkedOrders => linkedOrders.Any();

    protected override async Task OnInitializedAsync()
    {
        var oe = await database.GetOrderById(Id);
        var detailsEntity = await database.GetOrderDetails(Id);

        var orderData = new OrderViewModel()
        {
            OrderId = oe.order_id.ToString(),
            City = oe.payment_city,
            Customer = oe.payment_firstname,
            DateTime = oe.date_added,
            OrderStatus = oe.order_status,
            TotalPrice = oe.total,
            Comment = oe.comment,
            CustomerEmail = oe.email,
            CustomerPhoneNumber = oe.telephone,
            ShippingAddress = oe.shipping_address_1,
            PaymentMethod = oe.payment_method,
            ShippingMethod = oe.shipping_method,
            OrderDetails = detailsEntity.Select(ode => new OrderDetailsViewModel()
            {
                ProductName = ode.name,
                Model = ode.model,
                Sku = ode.sku,
                Price = ode.price,
                ProductId = ode.product_id,
                Quantity = ode.quantity,
                Manufacturer = ode.manufacturer
            }).ToList()
        };
        order = orderData;

        linkedOrders = await database.GetLinkedOrders(oe);
    }

    private async Task GoToPrintPage()
    {
        string printPage = navigationManager.Uri + "/print";
        await js.InvokeAsync<object>("open", printPage, "_blank");
    }

    private async Task OnLinkedOrderMouseDoubleClick(OrderEntity clickedOrder)
    {
        string linkedOrderPage = navigationManager.Uri.Replace("/" + Id, "/" + clickedOrder.order_id);
        await js.InvokeAsync<object>("open", linkedOrderPage, "_blank");
    }
}


