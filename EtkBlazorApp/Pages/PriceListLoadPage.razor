@page "/load-price-list"
@attribute [Authorize(Roles = "Administrator, Manager")]
@inject PriceListManager priceListManager
@inject UserLogger logger
@inject RemoteTemplateFileLoaderFactory remoteTemplateFileLoaderFactory
@inject ITemplateStorage templateStorage
@inject IToastService toast
@using System.Threading

@if (isBusy)
{
    if (isFileUploading)
    {
        <h3>Загрузка файла на сервер</h3>
        <BootstrapProgressBar CurrentProgress="uploadPercent"></BootstrapProgressBar>
        @*<button class="btn btn-outline-info" @onclick="@(e => cts?.Cancel())">
            Отменить загрузку
        </button>*@
    }
    if (isIntermediateProgress)
    {
        <h3>Обработка данных</h3>
        <IntermediateProgressBar></IntermediateProgressBar>
    }
}


<button class="btn btn-success" @onclick="LoadRemoteUriTemplate" disabled="@(string.IsNullOrWhiteSpace(selectedTemplate?.RemoteUrl) || isBusy)">
    Загрузить от поставщика
</button>
<InputFile OnChange="@UploadSelectedPriceListTemplateFile" disabled="@(selectedTemplate == null || isBusy)">
</InputFile>

<h2>Выберите шаблон загружаемого файла</h2>

<div class="row my-2">
    <div class="input-group" style="width: 425px;">
        <button type="button" style="margin-left: 8px;" class="btn btn-outline-primary" @onclick="@(e => ApplyFilter(null))">Поиск</button>
        <input type="search"
               @onkeypress="ApplyFilter"
               @oninput="@(ui => searchPhrase = (string)ui.Value)"
               @bind="searchPhrase" class="form-control rounded mx-2" />
    </div>
    @*<div class="float-right">
        <label for="chbx-only-remote-files">С файлами по ссылке</label>
        <input type="checkbox" class="form-check" @bind="showOnlyWithRemoteFile" />
    </div>*@
</div>

<div class="row">
    @foreach (var template in filteredTemplates)
    {
        <CascadingValue Value="selectedTemplate">
            <PriceListTemplateItem Items="@template.Value" CheckedChanged="SelectedTemplateChanged" />
        </CascadingValue>
    }
</div>

<hr />

@if (selectedTemplate != null)
{
    <h4>Примечания к выбранному шаблону <storng>(@selectedTemplate.Title)</storng></h4>
    <textarea readonly class="price-list-template-description">@selectedTemplate.Description</textarea>
    @if (selectedTemplate.PriceListType == PriceListType.Price || selectedTemplate.PriceListType == PriceListType.Both)
    {
        @if (selectedTemplate.Nds)
        {
            <p>
                <strong style="color: red;">прибавляется НДС</strong>
            </p>
        }
        <p>
            Наценка:
            @if (editingTemplate == selectedTemplate)
            {
                <input type="number" style="display: inline; width: 80px;" class="form-control mx-2" @bind="editingTemplate.Discount" />
                <button class="btn btn-outline-success" @onclick="SaveTemplateDiscount">
                    <span class="oi oi-circle-check" style="font-size: 16px;"></span>
                </button>
            }
            else
            {
                <strong style="color: red;">@(selectedTemplate.Discount.ToString("G29"))%</strong>
                <button class="btn btn-sm btn-outline-success mx-2" @onclick="(e => editingTemplate = selectedTemplate)">
                    <span class="oi oi-pencil"></span>
                </button>
            }
        </p>
    }
    @if (selectedTemplate.RemoteUrl != null)
    {
        <p>Прямая ссылка на файл: <a href="@selectedTemplate.RemoteUrl" target="_blank">@selectedTemplate.RemoteUrl</a></p>
    }
    <hr />
}

@if (priceListManager.LoadedFiles.Any())
{
    <a href="/update-products" class="btn btn-lg btn-outline-primary">Перейти к обновлению товаров</a>
}

@code
{
    const int MAX_UPLOAD_FILE_SIZE = 15_000_000; // 15 мб
    const int UPLOAD_BUFFER_SIZE = 64_000; // 64 кб

    Dictionary<string, List<PriceListTemplateItemViewModel>> templates = null;
    Dictionary<string, List<PriceListTemplateItemViewModel>> filteredTemplates;
    PriceListTemplateItemViewModel selectedTemplate = null;
    PriceListTemplateItemViewModel editingTemplate = null;

    string searchPhrase;
    //bool showOnlyWithRemoteFile = false;
    CancellationTokenSource cts;
    bool isIntermediateProgress = false;
    bool isFileUploading = false;
    bool isBusy => isIntermediateProgress || isFileUploading;
    int uploadPercent = 0;

    protected override async Task OnInitializedAsync()
    {
        cts = new CancellationTokenSource();
        templates = (await templateStorage.GetPriceListTemplates())
            .Select(t => new PriceListTemplateItemViewModel(t.id)
            {
                Description = t.description,
                Discount = t.discount,
                GroupName = t.group_name,
                Image = t.image,
                Manufacturer = t.manufacturer,
                PriceListType = (PriceListType)t.price_list_type,
                RemoteUrl = t.remote_uri,
                RemoteUrlMethod = t.remote_uri_method,
                Title = t.title,
                Nds = t.nds
            })
            .GroupBy(template => template.GroupName ?? "<Без группы>")
            .OrderBy(g => g.Key == "Symmetron" ? 0 : 1)
            .ThenBy(g => g.Key)
            .ToDictionary(i => i.Key, i => i.ToList());

        filteredTemplates = templates;
    }

    private async Task UploadSelectedPriceListTemplateFile(InputFileChangeEventArgs e)
    {
        isFileUploading = true;
        uploadPercent = 0;
        var bytes = new byte[(int)e.File.Size];

        using (var uploadStream = e.File.OpenReadStream(MAX_UPLOAD_FILE_SIZE, cts.Token))
        {
            int readed = 0;

            while ((readed += await uploadStream.ReadAsync(bytes, readed, Math.Min(UPLOAD_BUFFER_SIZE, bytes.Length - readed))) < bytes.Length)
            {
                uploadPercent = (int)(((double)readed / bytes.Length) * 100);
                StateHasChanged();
            }
        }

        isFileUploading = false;
        StateHasChanged();

        using (var ms = new MemoryStream(bytes))
        {
            await LoadTemplateFromStream(ms);
        }
    }

    private async Task LoadRemoteUriTemplate()
    {
        isIntermediateProgress = true;
        StateHasChanged();

        IRemoteTemplateFileLoader loader = remoteTemplateFileLoaderFactory.GetMethod(selectedTemplate.RemoteUrl, selectedTemplate.RemoteUrlMethod, selectedTemplate.Guid);
        using (var ms = new MemoryStream(await loader.GetBytes()))
        {
            await LoadTemplateFromStream(ms);
        }
    }

    private async Task LoadTemplateFromStream(Stream stream)
    {
        isIntermediateProgress = true;
        StateHasChanged();

        try
        {
            await priceListManager.UploadTemplate(selectedTemplate.Type, stream);
            int readedLines = priceListManager.LoadedFiles.Last().ReadedPriceLines.Count;

            await logger.Write(LogEntryGroupName.PriceListTemplateLoad, "Файл загружен", $"Загружен прайс-лист '{selectedTemplate.Type} ({readedLines} строк)'");
            toast.ShowSuccess($"Файл считан ({readedLines} строк)", selectedTemplate.Title);
        }
        catch (NotFoundedPriceListTemplateException)
        {
            await logger.Write(LogEntryGroupName.PriceListTemplateLoad, "Ошибка загрузки", $"Шаблон для '{selectedTemplate.Type}' не реализован'");
            toast.ShowError($"Шаблон не реализован!", selectedTemplate.Title);
        }
        catch (Exception ex)
        {
            await logger.Write(LogEntryGroupName.PriceListTemplateLoad, "Ошибка загрузки", $"Ошибка загрузки файла с шаблоном {selectedTemplate.Title}. Ошибка: {ex.Message}");
            toast.ShowError("Ошибка: " + ex.Message, selectedTemplate.Title);
        }
        finally
        {
            isIntermediateProgress = false;
            selectedTemplate = null;
            StateHasChanged();
        }

    }

    private void SelectedTemplateChanged(PriceListTemplateItemViewModel e)
    {
        editingTemplate = null;
        selectedTemplate = e;
    }

    private async Task SaveTemplateDiscount()
    {
        await templateStorage.ChangePriceListTemplateDiscount(selectedTemplate.Guid, selectedTemplate.Discount);
        editingTemplate = null;
        toast.ShowSuccess("Скидка изменена");
        await logger.Write(LogEntryGroupName.TemplateUpdate, "Обновлено", $"Скидка для шаблона {selectedTemplate.Title} ({selectedTemplate.Guid}) изменена на {selectedTemplate.Discount.ToString("G29")}");
    }

    private void ApplyFilter(KeyboardEventArgs e)
    {
        if (e == null || e.Key == "Enter")
        {
            if (!string.IsNullOrEmpty(searchPhrase))
            {
                filteredTemplates = templates
                    .Where(g => g.Key.Contains(searchPhrase) ||
                                g.Value.Any(t => t.Title.IndexOf(searchPhrase, StringComparison.OrdinalIgnoreCase) >= 0) ||
                                g.Value.Any(t => t.Manufacturer != null && t.Manufacturer.IndexOf(searchPhrase, StringComparison.OrdinalIgnoreCase) >= 0)
                            )
                    .ToDictionary(g => g.Key, g => g.Value);
            }
            else
            {
                filteredTemplates = templates;
            }
        }
    }
}
